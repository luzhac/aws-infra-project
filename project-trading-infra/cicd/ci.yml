name: CI Pipeline test/lint/scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  pytest:
    runs-on: ubuntu-latest
    env:
      frequency: "1m"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.9"
      - run: pip install -r requirements.txt || true
      - run: pip install pytest
      - run: pytest -v --maxfail=1 --disable-warnings
        continue-on-error: true

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.9"
      - run: pip install flake8 pylint mypy

      - run: flake8 .
        continue-on-error: true
      - run: pylint $(git ls-files '*.py') || true
        continue-on-error: true
      - run: mypy .
        continue-on-error: true

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - run: docker build -t crypto-trade:latest .
      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "crypto-trade:latest"
          format: "table"
          exit-code: "0"
          severity: "CRITICAL,HIGH"
